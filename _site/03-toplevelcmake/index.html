















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2021-10-06 06:55:35 -0700">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - ATLAS CMake"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  The Top-Level CMakeLists.txt &ndash; ATLAS CMake
  </title>  

  </head>
  <body>

    


<div class="panel panel-default life-cycle">
  <div id="life-cycle" class="panel-body pre-alpha">
    This lesson is still being designed and assembled (Pre-Alpha version)
  </div>
</div>





    <div class="container">
      






<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-introduction/index.html">Introduction to ATLAS Offline Software</a></li>
            
            <li><a href="../02-workspace/index.html">Your Workspace</a></li>
            
            <li><a href="../03-toplevelcmake/index.html">The Top-Level CMakeLists.txt</a></li>
            
            <li><a href="../04-packagecmake/index.html">The Package CMakeLists.txt</a></li>
            
            <li><a href="../05-coffee/index.html">Coffee break!</a></li>
            
            <li><a href="../06-addcalibration/index.html">Calibrate Your Jets</a></li>
            
            <li><a href="../07-modifyingathena/index.html">Modyfing an Athena Package</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio/index.html">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            <li><a href="../about/index.html">About</a></li>
            
            <li><a href="../discuss/index.html">Discussion</a></li>
            
            <li><a href="../figures/index.html">Figures</a></li>
            
            <li><a href="../guide/index.html">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
	
	<li><a href="/edit//_episodes/03-toplevelcmake.md" data-checker-ignore>Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>

















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../02-workspace/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">ATLAS CMake</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../04-packagecmake/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">The Top-Level CMakeLists.txt</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 20 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do I tell CMake about all my packages?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Setup an ATLAS release</p>
</li>
	
	<li><p>Build a top-level workspace that identifies your packages</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>Now that we have reorganized our code, it is time to try to write the <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> that use some useful ATLAS macros. By using the ATLAS macros, you simplify your life by automating certain tasks like dependency look-up, placing all your binaries in convenient places and preparing an archive that can be uploaded to the grid.</p>

<p>In this section, we will write the top-level <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> that will setup your environment and include all of your custom packages. In practice, this is a generic file that can be copied from the ATLAS Software Documentation. However today we will write it ourselves, to understand what it is doing.</p>

<h1 id="writing-the-cmakeliststxt">Writing the CMakeLists.txt</h1>

<p>Start by opening the <code class="language-plaintext highlighter-rouge">source/CMakeLists.txt</code> file that contains our current CMake build instructions and removing all of the contents. Then start by telling CMake that you will be using command available only in version 3.14 and beyond.</p>

<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set the minimum required CMake version:</span>
<span class="nb">cmake_minimum_required</span><span class="p">(</span> VERSION 3.14 FATAL_ERROR <span class="p">)</span>
</code></pre></div></div>

<p>The next step tries to automatically determine what ATLAS project you are using. By automating this task, you can easily transition between different projects to test your code in different environments. Remember, out-of-source builds are awesome for this!</p>

<p>The way this block works is by looping over all known projects (hardcoded as the <code class="language-plaintext highlighter-rouge">_parentProjectNames</code> list) and seeing if the <code class="language-plaintext highlighter-rouge">ProjectName_DIR</code> environmental variables has been set. After you run <code class="language-plaintext highlighter-rouge">source release_setup.sh</code> in your Docker image or <code class="language-plaintext highlighter-rouge">asetup AnalysisBase,21.2.125</code> when using CVMFS, this variable will contain the installation path of the project.</p>

<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Try to figure out what project is our parent. Just using a hard-coded list</span>
<span class="c1"># of possible project names. Basically the names of all the other</span>
<span class="c1"># sub-directories inside the Projects/ directory in the repository.</span>
<span class="nb">set</span><span class="p">(</span> _parentProjectNames Athena AthenaP1 AnalysisBase AthAnalysis
   AthSimulation AthDerivation AnalysisTop <span class="p">)</span>
<span class="nb">set</span><span class="p">(</span> _defaultParentProject AnalysisBase <span class="p">)</span>
<span class="nb">foreach</span><span class="p">(</span> _pp <span class="si">${</span><span class="nv">_parentProjectNames</span><span class="si">}</span> <span class="p">)</span>
   <span class="nb">if</span><span class="p">(</span> NOT <span class="s2">"$ENV{</span><span class="si">${</span><span class="nv">_pp</span><span class="si">}</span><span class="s2">_DIR}"</span> STREQUAL <span class="s2">""</span> <span class="p">)</span>
      <span class="nb">set</span><span class="p">(</span> _defaultParentProject <span class="si">${</span><span class="nv">_pp</span><span class="si">}</span> <span class="p">)</span>
      <span class="nb">break</span><span class="p">()</span>
   <span class="nb">endif</span><span class="p">()</span>
<span class="nb">endforeach</span><span class="p">()</span>

<span class="c1"># Set the parent project name based on the previous findings:</span>
<span class="nb">set</span><span class="p">(</span> ATLAS_PROJECT <span class="si">${</span><span class="nv">_defaultParentProject</span><span class="si">}</span>
   CACHE STRING <span class="s2">"The name of the parent project to build against"</span> <span class="p">)</span>

<span class="c1"># Clean up:</span>
<span class="nb">unset</span><span class="p">(</span> _parentProjectNames <span class="p">)</span>
<span class="nb">unset</span><span class="p">(</span> _defaultParentProject <span class="p">)</span>
</code></pre></div></div>

<p>Once we know which ATLAS project is being used, we tell CMake about it using the standard <code class="language-plaintext highlighter-rouge">FIND_PACKAGE</code> command. This configures all of the paths to the central packages and loads the CMake macros that we will use in the next section.</p>

<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find the AnalysisBase project. This is what, amongst other things, pulls</span>
<span class="c1"># in the definition of all of the "atlas_" prefixed functions/macros.</span>
<span class="nb">find_package</span><span class="p">(</span> <span class="si">${</span><span class="nv">ATLAS_PROJECT</span><span class="si">}</span> REQUIRED <span class="p">)</span>
</code></pre></div></div>

<p>The next line uses a custom ATLAS macro to make writing unit tests easier. We will not dive into that here.</p>

<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set up CTest. This makes sure that per-package build log files can be</span>
<span class="c1"># created if the user so chooses.</span>
<span class="nf">atlas_ctest_setup</span><span class="p">()</span>
</code></pre></div></div>

<p>The next step is how CMake learns what local packages you have in your repository. The <code class="language-plaintext highlighter-rouge">ATLAS_PROJECT</code> macro scans through all of the subdirectories, looking for ones containing a <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> file. All such directories are then defined as packages and included in the compilation.</p>

<p>The macro also provides a manual way to control packages that are compiled through a <code class="language-plaintext highlighter-rouge">package_filters.txt</code> file. We will not go into that here, but it is very useful when having a clone of the athena repository in your workspace.</p>

<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># With this CMake will look for "packages"</span>
<span class="c1"># in the current repository and all of its submodules, respecting the</span>
<span class="c1"># "package_filters.txt" file, and set up the build of those packages.</span>
<span class="nf">atlas_project</span><span class="p">(</span> UserAnalysis 1.0.0
   USE <span class="si">${</span><span class="nv">ATLAS_PROJECT</span><span class="si">}</span> <span class="si">${${</span><span class="nv">ATLAS_PROJECT</span><span class="si">}</span><span class="nv">_VERSION</span><span class="si">}</span> <span class="p">)</span>
</code></pre></div></div>

<p>The ATLAS CMake framework creates a convenient setup script that puts all of your binaries into the relevant paths (ie: <code class="language-plaintext highlighter-rouge">PATH</code> and <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code>). This way you can run the programs from any place you want, without caring where they are installed. The following set of lines copies the setup script into your build directory.</p>

<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set up the runtime environment setup script. This makes sure that the</span>
<span class="c1"># project's "setup.sh" script can set up a fully functional runtime environment,</span>
<span class="c1"># including all the externals that the project uses.</span>
<span class="nf">lcg_generate_env</span><span class="p">(</span> SH_FILE <span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">ATLAS_PLATFORM</span><span class="si">}</span>/env_setup.sh <span class="p">)</span>
<span class="nb">install</span><span class="p">(</span> FILES <span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">ATLAS_PLATFORM</span><span class="si">}</span>/env_setup.sh
   DESTINATION . <span class="p">)</span>
</code></pre></div></div>

<p>The final step is to setup CPack. This is a CMake module that can generate distributable packages from your compiled binaries. This is used by Panda, the grid job management tool, to upload your code to the cloud when running over many big files.</p>
<div class="language-cmake source highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set up CPack. This call makes sure that an RPM or TGZ file can be created</span>
<span class="c1"># from the built project. Used by Panda to send the project to the grid worker</span>
<span class="c1"># nodes.</span>
<span class="nf">atlas_cpack_setup</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="building-your-workspace">Building your Workspace</h1>
<p>Start by removing the `JetSelectionHelper/</p>

<p>Now that we have written the top-level <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> file, it is time to try to compile everything. Make sure that you have loaded the AnalysisBase release using the <code class="language-plaintext highlighter-rouge">release_setup.sh</code> script. Run the following commands inside the <code class="language-plaintext highlighter-rouge">build/</code> directory. The first command runs CMake to create a <code class="language-plaintext highlighter-rouge">Makefile</code> that can compile your entire workspace. The second command configures your environment with the necessary paths, as described earlier.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run from build/ directory</span>
cmake ../source
<span class="nb">source </span>x86_64-centos7-gcc8-opt/setup.sh
</code></pre></div></div>

<p>If you wrote the <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> file correctly, you should see a bunch of output saying random dependencies have been found and end with the following.</p>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Lots of boring text

-- Configuring done
-- Configuring done
-- Generating done
-- Build files have been written to: /home/atlas/Bootcamp/v4-gitmodule-submodule-jetselector-simplecmake/build
</code></pre></div></div>

<p>Now let’s try to compile our source code by running <code class="language-plaintext highlighter-rouge">make</code>. You should quickly see the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Scanning dependencies of target atlas_tests
Built target atlas_tests
</code></pre></div></div>

<p>That was quick! We haven’t written our package’s <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> files, so it does not compile them. That’s what we will do next.</p>

<blockquote class="challenge">
  <h2 id="restoring-your-environment">Restoring Your Environment</h2>

  <p>When you come back to your workspace at a later date, what commands do you run to setup the environment?</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <p>You need to run two commands. One to setup the ATLAS project and the second to configure the enviroment of your workspace. You do not have to rerun <code class="language-plaintext highlighter-rouge">cmake</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run from build/ directory</span>
<span class="nb">source</span> ~/release_setup.sh 
<span class="nb">source </span>x86_64-centos7-gcc8-opt/setup.sh 
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Configured GCC from: /opt/lcg/gcc/8.3.0-cebb0/x86_64-centos7/bin/gcc
Configured AnalysisBase from: /usr/AnalysisBase/21.2.125/InstallArea/x86_64-centos7-gcc8-opt
</code></pre></div>    </div>
  </blockquote>
</blockquote>



<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Copy-paste the generic <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> from the ATLAS Software Documentation and place it inside the <code class="language-plaintext highlighter-rouge">source/</code> directory.</p>
</li>
    
  </ul>
</blockquote>

</article>
















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../02-workspace/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../04-packagecmake/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 copyright" align="left">
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2021
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	<a href="/edit//_episodes/03-toplevelcmake.md" data-checker-ignore>Edit on GitHub</a>
	
	/
	<a href="/blob//CONTRIBUTING.md" data-checker-ignore>Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:kkrizka@gmail.com">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
